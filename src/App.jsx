import { useEffect, useMemo, useRef, useState, useCallback } from 'react';
import { MapContainer, TileLayer, Marker, Popup } from 'react-leaflet';
import 'leaflet/dist/leaflet.css';
import L from 'leaflet';

// Leaflet marker icon fix - CDN yerine local assets kullan
delete L.Icon.Default.prototype._getIconUrl;
L.Icon.Default.mergeOptions({
  iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
  iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
  shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
});

const API = 'https://kurye-takip-backend.onrender.com/api';

// Alanya semtleri - sadece ana semtler
const ALANYA_DISTRICTS = [
  'Mahmutlar',
  'Kleopatra', 
  'Oba',
  'Tosmur',
  'Kestel',
  'Gullerpinari',
  'Hacet',
  'Kale'
];

export default function App() {
  const [screen, setScreen] = useState('login');
  const [role, setRole] = useState(null);
  const [currentUser, setCurrentUser] = useState(null);
  const [notification, setNotification] = useState(null);
  const [token, setToken] = useState(null);
  const [profile, setProfile] = useState(null);

  // Session persistence - sayfa yenilendiƒüinde kullanƒ±cƒ± bilgilerini geri y√ºkle
  useEffect(() => {
    const savedToken = localStorage.getItem('deliveryPro_token');
    const savedRole = localStorage.getItem('deliveryPro_role');
    const savedUser = localStorage.getItem('deliveryPro_user');
    const savedProfile = localStorage.getItem('deliveryPro_profile');

    if (savedToken && savedRole && savedUser && savedProfile) {
      try {
        setToken(savedToken);
        setRole(savedRole);
        setCurrentUser(JSON.parse(savedUser));
        setProfile(JSON.parse(savedProfile));
        setScreen('app');
      } catch (error) {
        console.error('Session restore error:', error);
        // Hatalƒ± session'ƒ± temizle
        localStorage.removeItem('deliveryPro_token');
        localStorage.removeItem('deliveryPro_role');
        localStorage.removeItem('deliveryPro_user');
        localStorage.removeItem('deliveryPro_profile');
      }
    }
  }, []);

  const showNotification = (text, type) => {
    setNotification({ text, type });
    setTimeout(() => setNotification(null), 3000);
  };

  const handleAuthenticated = (r, tok, serverProfile, uiUser) => {
    // Session'ƒ± localStorage'a kaydet
    localStorage.setItem('deliveryPro_token', tok);
    localStorage.setItem('deliveryPro_role', r);
    localStorage.setItem('deliveryPro_user', JSON.stringify(uiUser));
    localStorage.setItem('deliveryPro_profile', JSON.stringify(serverProfile));
    
            setRole(r);
            setToken(tok);
            setProfile(serverProfile);
            setCurrentUser(uiUser);
            setScreen('app');
  };

  const handleLogout = () => {
    // Session'ƒ± temizle
    localStorage.removeItem('deliveryPro_token');
    localStorage.removeItem('deliveryPro_role');
    localStorage.removeItem('deliveryPro_user');
    localStorage.removeItem('deliveryPro_profile');
    
    setScreen('login');
    setRole(null);
    setCurrentUser(null);
    setToken(null);
    setProfile(null);
  };

  const goToAdmin = () => {
    setScreen('admin');
  };

  return (
    <div>
      {screen === 'login' && (
        <LoginScreen
          onAuthenticated={handleAuthenticated}
          onAdminAccess={goToAdmin}
          notify={showNotification}
        />
      )}
      {screen === 'admin' && (
        <AdminPanel
          onLogout={handleLogout}
          notify={showNotification}
        />
      )}
      {screen === 'app' && role && (
        <MainApp
          role={role}
          currentUser={currentUser}
          token={token}
          profile={profile}
          onLogout={handleLogout}
          notify={showNotification}
        />
      )}
      {notification && (
        <div
          id="notification"
          className={`notification ${notification.type === 'error' ? 'error' : ''} ${notification.type === 'warning' ? 'warning' : ''}`}
          style={{ display: 'block' }}
        >
          {notification.text}
        </div>
      )}
    </div>
  );
}

function LoginScreen({ onAuthenticated, onAdminAccess, notify }) {
  const [selectedRole, setSelectedRole] = useState(null);
  const [isLoginMode, setIsLoginMode] = useState(true);
  const storeNameRef = useRef(null);
  const storeAddressRef = useRef(null);
  const storeDistrictRef = useRef(null);
  const storeEmailRef = useRef(null);
  const storePasswordRef = useRef(null);
  const courierNameRef = useRef(null);
  const courierPhoneRef = useRef(null);
  const courierEmailRef = useRef(null);
  const courierPasswordRef = useRef(null);
  const courierAddressRef = useRef(null);
  const courierDistrictRef = useRef(null);

    return (
    <div id="loginScreen" className="login-container">
      <div className="login-box">
        <h1 className="login-title">üöö DeliveryPro</h1>
        <p className="login-subtitle">Hƒ±zlƒ± ve g√ºvenilir paket teslimat sistemi</p>

        <div className="role-buttons">
          <div className={`role-btn ${selectedRole === 'store' ? 'selected' : ''}`} onClick={() => setSelectedRole('store')}>
            <div className="role-icon">üè™</div>
            <div className="role-name">D√ºkkan</div>
          </div>
          <div className={`role-btn ${selectedRole === 'courier' ? 'selected' : ''}`} onClick={() => setSelectedRole('courier')}>
            <div className="role-icon">üèçÔ∏è</div>
            <div className="role-name">Kurye</div>
          </div>
        </div>

        {/* Admin Panel Eri≈üimi */}
        <div style={{ textAlign: 'center', marginTop: 20 }}>
          <button
            className="admin-access-btn"
            onClick={onAdminAccess}
            style={{
              background: 'none',
              border: 'none',
              color: '#666',
              textDecoration: 'underline',
              cursor: 'pointer',
              fontSize: '0.9rem'
            }}
          >
            üîê Y√∂netici Paneli
          </button>
          </div>

        {selectedRole && (
          <div className="mode-toggle">
            <button 
              className={`mode-btn ${isLoginMode ? 'active' : ''}`}
              onClick={() => setIsLoginMode(true)}
            >
              üîë Giri≈ü Yap
            </button>
            <button 
              className={`mode-btn ${!isLoginMode ? 'active' : ''}`}
              onClick={() => setIsLoginMode(false)}
            >
              üìù Kayƒ±t Ol
            </button>
          </div>
        )}

        {selectedRole === 'store' && (
          <div id="storeLogin" className="login-form active">
          <div className="form-group">
            <label htmlFor="storeEmail">E-posta:</label>
            <input type="email" id="storeEmail" placeholder="ornek@site.com" ref={storeEmailRef} />
          </div>
          <div className="form-group">
            <label htmlFor="storePassword">≈ûifre:</label>
            <input type="password" id="storePassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" ref={storePasswordRef} />
          </div>
            
            {!isLoginMode && (
              <>
                <div className="form-group">
                  <label htmlFor="storeName">D√ºkkan Adƒ±:</label>
                  <input type="text" id="storeName" placeholder="√ñrn: Mehmet Market" ref={storeNameRef} />
                </div>
                <div className="form-group">
                  <label htmlFor="storeDistrict">Semt:</label>
                  <select id="storeDistrict" ref={storeDistrictRef}>
                    <option value="">Semt se√ßin...</option>
                    {ALANYA_DISTRICTS.map(district => (
                      <option key={district} value={district}>{district}</option>
                    ))}
                  </select>
                </div>
                <div className="form-group">
                  <label htmlFor="storeAddress">Detaylƒ± Adres:</label>
                  <input type="text" id="storeAddress" placeholder="Mahalle, sokak, bina no..." ref={storeAddressRef} />
                </div>
              </>
            )}

            <button
              className="btn-primary"
              onClick={async () => {
                const email = (storeEmailRef.current?.value || '').trim();
                const password = (storePasswordRef.current?.value || '').trim();
                
                if (!email) return notify('E-posta zorunludur', 'error');
                if (!password) return notify('≈ûifre zorunludur', 'error');
                
                if (isLoginMode) {
                  // Giri≈ü
                  try {
                    const r = await fetch(`${API}/auth/login/shop`, { 
                      method: 'POST', 
                      headers: { 'Content-Type': 'application/json' }, 
                      body: JSON.stringify({ email, password }) 
                    });
                    const d = await r.json(); 
                    if (!r.ok) throw new Error(d.error || 'Giri≈ü ba≈üarƒ±sƒ±z');
                    
                  const token = d.token;
                  const meRes = await fetch(`${API}/shops/me`, { headers: { Authorization: `Bearer ${token}` } });
                  const me = await meRes.json();
                  
                  if (!me.me) {
                    throw new Error('D√ºkkan bilgileri alƒ±namadƒ±');
                  }
                  
                  const uiUser = { name: me.me.name, address: me.me.addressText, type: 'store' };
                  onAuthenticated('store', token, me.me, uiUser);
                    notify(`Ho≈ü geldiniz ${me.me.name}!`);
                  } catch (e) { 
                    notify(e.message, 'error'); 
                  }
                } else {
                  // Kayƒ±t
                  const name = (storeNameRef.current?.value || '').trim();
                  const district = (storeDistrictRef.current?.value || '').trim();
                  const addressText = (storeAddressRef.current?.value || '').trim();
                  
                  if (!name) return notify('D√ºkkan adƒ± zorunludur', 'error');
                  if (!district) return notify('Semt se√ßimi zorunludur', 'error');
                  if (!addressText) return notify('Adres zorunludur', 'error');
                  
                  const fullAddress = `${addressText}, ${district}`;
                  
                  try {
                    const r = await fetch(`${API}/auth/register/shop`, { 
                      method: 'POST', 
                      headers: { 'Content-Type': 'application/json' }, 
                      body: JSON.stringify({ name, email, password, addressText: fullAddress, district }) 
                    });
                    const d = await r.json(); 
                    if (!r.ok) throw new Error(d.error || 'Kayƒ±t ba≈üarƒ±sƒ±z');
                    
                  const token = d.token;
                  const meRes = await fetch(`${API}/shops/me`, { headers: { Authorization: `Bearer ${token}` } });
                  const me = await meRes.json();
                  
                  if (!me.me) {
                    throw new Error('D√ºkkan bilgileri alƒ±namadƒ±');
                  }
                  
                  const uiUser = { name: me.me.name, address: me.me.addressText, type: 'store' };
                  onAuthenticated('store', token, me.me, uiUser);
                    notify(`Ho≈ü geldiniz ${me.me.name}! Sipari≈ü olu≈üturmaya ba≈ülayabilirsiniz.`);
                  } catch (e) { 
                    notify(e.message, 'error'); 
                  }
                }
              }}
            >
              {isLoginMode ? 'üîë Giri≈ü Yap' : 'üìù Kayƒ±t Ol'}
            </button>
          </div>
        )}

        {selectedRole === 'courier' && (
          <div id="courierLogin" className="login-form active">
            <div className="form-group">
              <label htmlFor="courierEmail">E-posta:</label>
              <input type="email" id="courierEmail" placeholder="ornek@site.com" ref={courierEmailRef} />
            </div>
            <div className="form-group">
              <label htmlFor="courierPassword">≈ûifre:</label>
              <input type="password" id="courierPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" ref={courierPasswordRef} />
        </div>

            {!isLoginMode && (
              <>
          <div className="form-group">
            <label htmlFor="courierName">Kurye Adƒ±:</label>
            <input type="text" id="courierName" placeholder="Adƒ±nƒ±z Soyadƒ±nƒ±z" ref={courierNameRef} />
          </div>
          <div className="form-group">
                  <label htmlFor="courierPhone">Telefon:</label>
            <input type="tel" id="courierPhone" placeholder="05xx xxx xx xx" ref={courierPhoneRef} />
          </div>
               </>
            )}

            <button
              className="btn-primary"
              onClick={async () => {
                const email = (courierEmailRef.current?.value || '').trim();
                const password = (courierPasswordRef.current?.value || '').trim();
                
                if (!email) return notify('E-posta zorunludur', 'error');
                if (!password) return notify('≈ûifre zorunludur', 'error');
                
                if (isLoginMode) {
                  // Giri≈ü
                  try {
                    const r = await fetch(`${API}/auth/login/courier`, { 
                      method: 'POST', 
                      headers: { 'Content-Type': 'application/json' }, 
                      body: JSON.stringify({ email, password }) 
                    });
                    const d = await r.json(); 
                    if (!r.ok) throw new Error(d.error || 'Giri≈ü ba≈üarƒ±sƒ±z');
                    
                  const token = d.token;
                  const meRes = await fetch(`${API}/couriers/me`, { headers: { Authorization: `Bearer ${token}` } });
                  const me = await meRes.json();
                    
                  if (!me.me) {
                    throw new Error('Kurye bilgileri alƒ±namadƒ±');
                  }
                    
                  // GPS izni varsa konumu g√∂nder ve aktif yap
                  try {
                    const pos = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition((p) => res(p), () => res(null), { enableHighAccuracy: true, timeout: 5000 }));
                    if (pos) {
                        await fetch(`${API}/couriers/location`, { 
                          method: 'POST', 
                          headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` }, 
                          body: JSON.stringify({ coords: { lng: pos.coords.longitude, lat: pos.coords.latitude } }) 
                        });
                    }
                  } catch {}
                    
                                         await fetch(`${API}/couriers/status`, { 
                       method: 'POST', 
                       headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` }, 
                       body: JSON.stringify({ active: true }) 
                     });
                     
                     const uiUser = { id: me.me._id, name: me.me.name, phone: me.me.phone || '-', location: 'GPS ile takip ediliyor', status: 'available' };
                     onAuthenticated('courier', token, me.me, uiUser);
                     notify(`Ho≈ü geldiniz ${me.me.name}! Sistem aktif, sipari≈üler gelmeye ba≈ülayabilir.`);
                 } catch (e) { notify(e.message, 'error'); }
                } else {
                  // Kayƒ±t
                  const name = (courierNameRef.current?.value || '').trim();
                  const phone = (courierPhoneRef.current?.value || '').trim();
                  
                  if (!name) return notify('ƒ∞sim zorunludur', 'error');
                  if (!phone) return notify('Telefon zorunludur', 'error');
                  
                  try {
                    const r = await fetch(`${API}/auth/register/courier`, { 
                      method: 'POST', 
                      headers: { 'Content-Type': 'application/json' }, 
                      body: JSON.stringify({ name, email, password, phone }) 
                    });
                    const d = await r.json(); 
                    if (!r.ok) throw new Error(d.error || 'Kayƒ±t ba≈üarƒ±sƒ±z');
                    
                    const token = d.token;
                    const meRes = await fetch(`${API}/couriers/me`, { headers: { Authorization: `Bearer ${token}` } });
                    const me = await meRes.json();
                    
                    // GPS izni varsa konumu g√∂nder ve aktif yap
                    try {
                      const pos = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition((p) => res(p), () => res(null), { enableHighAccuracy: true, timeout: 5000 }));
                      if (pos) {
                        await fetch(`${API}/couriers/location`, { 
                          method: 'POST', 
                          headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` }, 
                          body: JSON.stringify({ coords: { lng: pos.coords.longitude, lat: pos.coords.latitude } }) 
                        });
                      }
                    } catch {}
                    
                    await fetch(`${API}/couriers/status`, { 
                      method: 'POST', 
                      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` }, 
                      body: JSON.stringify({ active: true }) 
                    });
                    
                    const uiUser = { id: me.me._id, name: me.me.name, phone, location: 'GPS ile takip ediliyor', status: 'available' };
                    onAuthenticated('courier', token, me.me, uiUser);
                    notify(`Ho≈ü geldiniz ${me.me.name}! Sistem aktif, sipari≈üler gelmeye ba≈ülayabilir.`);
                  } catch (e) { notify(e.message, 'error'); }
                }
              }}
            >
              {isLoginMode ? 'üîë Giri≈ü Yap' : 'üìù Kayƒ±t Ol'}
            </button>
          </div>
        )}
        </div>
      </div>
    );
  }

function AdminPanel({ onLogout, notify }) {
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [adminPassword, setAdminPassword] = useState('');
  const [couriers, setCouriers] = useState([]);
  const [shops, setShops] = useState([]);
  const [loading, setLoading] = useState(false);

  const ADMIN_PASSWORD = 'admin123'; // Bu ≈üifreyi deƒüi≈ütirin

  const handleAdminLogin = () => {
    if (adminPassword === ADMIN_PASSWORD) {
      setIsAuthenticated(true);
      notify('üîê Y√∂netici paneline ho≈ü geldiniz!', 'success');
      fetchData();
    } else {
      notify('‚ùå Yanlƒ±≈ü ≈üifre!', 'error');
    }
  };

  const fetchData = async () => {
    setLoading(true);
    try {
      // Kuryeleri getir
      const courierRes = await fetch('https://kurye-takip-backend.onrender.com/api/couriers/all');
      const courierData = await courierRes.json();
      if (courierRes.ok) setCouriers(courierData.couriers || []);

      // D√ºkkanlarƒ± getir
              const shopRes = await fetch('https://kurye-takip-backend.onrender.com/api/shops/all');
      const shopData = await shopRes.json();
      if (shopRes.ok) setShops(shopData.shops || []);
    } catch (error) {
      notify('Veri y√ºklenirken hata olu≈ütu', 'error');
    } finally {
      setLoading(false);
    }
  };

  const deleteCourier = async (id) => {
    if (!confirm('Bu kuryeyi silmek istediƒüinizden emin misiniz?')) return;
    
    try {
              const res = await fetch(`https://kurye-takip-backend.onrender.com/api/couriers/${id}`, {
        method: 'DELETE'
      });
      if (res.ok) {
        notify('‚úÖ Kurye silindi', 'success');
        setCouriers(couriers.filter(c => c._id !== id));
      } else {
        notify('‚ùå Kurye silinemedi', 'error');
      }
    } catch (error) {
      notify('Silme i≈ülemi ba≈üarƒ±sƒ±z', 'error');
    }
  };

  const deleteShop = async (id) => {
    if (!confirm('Bu d√ºkkanƒ± silmek istediƒüinizden emin misiniz?')) return;
    
    try {
              const res = await fetch(`https://kurye-takip-backend.onrender.com/api/shops/${id}`, {
        method: 'DELETE'
      });
      if (res.ok) {
        notify('‚úÖ D√ºkkan silindi', 'success');
        setShops(shops.filter(s => s._id !== id));
      } else {
        notify('‚ùå D√ºkkan silinemedi', 'error');
      }
    } catch (error) {
      notify('Silme i≈ülemi ba≈üarƒ±sƒ±z', 'error');
    }
  };

  if (!isAuthenticated) {
    return (
      <div className="admin-login-container">
        <div className="admin-login-box">
          <h1>üîê Y√∂netici Paneli</h1>
          <p>Eri≈üim i√ßin ≈üifre girin</p>
          <div className="admin-form">
            <input
              type="password"
              placeholder="Y√∂netici ≈üifresi"
              value={adminPassword}
              onChange={(e) => setAdminPassword(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && handleAdminLogin()}
            />
            <button onClick={handleAdminLogin} className="btn-primary">
              üîë Giri≈ü Yap
            </button>
          </div>
          <button onClick={onLogout} className="btn-secondary">
            ‚Üê Geri D√∂n
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="admin-panel">
      <div className="admin-header">
        <h1>üîê Y√∂netici Paneli</h1>
        <div className="admin-actions">
          <button onClick={fetchData} className="btn btn-secondary">
            üîÑ Yenile
          </button>
          <button onClick={onLogout} className="btn btn-danger">
            √áƒ±kƒ±≈ü
          </button>
        </div>
      </div>

      {loading && (
        <div className="loading-overlay">
          <div className="loading-spinner">
            <div className="spinner"></div>
            <p>Y√ºkleniyor...</p>
          </div>
        </div>
      )}

      <div className="admin-content">
        {/* Kurye Y√∂netimi */}
        <div className="admin-section">
          <h2>üèçÔ∏è Kurye Y√∂netimi ({couriers.length})</h2>
          <div className="admin-grid">
            {couriers.map(courier => (
              <div key={courier._id} className="admin-card">
                <div className="admin-card-header">
                  <h3>{courier.name}</h3>
                  <span className={`status-badge ${courier.active ? 'status-available' : 'status-busy'}`}>
                    {courier.active ? 'Aktif' : 'Pasif'}
                  </span>
                </div>
                <div className="admin-card-content">
                  <p><strong>E-posta:</strong> {courier.email}</p>
                  <p><strong>Telefon:</strong> {courier.phone || '-'}</p>
                  <p><strong>Semt:</strong> {courier.district}</p>
                  <p><strong>Adres:</strong> {courier.addressText}</p>
                  <p><strong>Kayƒ±t:</strong> {new Date(courier.createdAt).toLocaleDateString('tr-TR')}</p>
                </div>
                <div className="admin-card-actions">
                  <button
                    onClick={() => deleteCourier(courier._id)}
                    className="btn btn-danger"
                  >
                    üóëÔ∏è Sil
                  </button>
                </div>
              </div>
            ))}
          </div>
        </div>

        {/* D√ºkkan Y√∂netimi */}
        <div className="admin-section">
          <h2>üè™ D√ºkkan Y√∂netimi ({shops.length})</h2>
          <div className="admin-grid">
            {shops.map(shop => (
              <div key={shop._id} className="admin-card">
                <div className="admin-card-header">
                  <h3>{shop.name}</h3>
                </div>
                <div className="admin-card-content">
                  <p><strong>E-posta:</strong> {shop.email}</p>
                  <p><strong>Semt:</strong> {shop.district}</p>
                  <p><strong>Adres:</strong> {shop.addressText}</p>
                  <p><strong>Kayƒ±t:</strong> {new Date(shop.createdAt).toLocaleDateString('tr-TR')}</p>
                </div>
                <div className="admin-card-actions">
                  <button
                    onClick={() => deleteShop(shop._id)}
                    className="btn btn-danger"
                  >
                    üóëÔ∏è Sil
                  </button>
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  );
}

function MainApp({ role, currentUser, token, profile, onLogout, notify }) {
  const [couriers, setCouriers] = useState([]);
  const [orders, setOrders] = useState([]);
  const [activeTime, setActiveTime] = useState(0);
  const [isCourierActive, setIsCourierActive] = useState(false);
  const [nearbyCouriers, setNearbyCouriers] = useState([]);
  const [nearbyShops, setNearbyShops] = useState([]);
  const [showMap, setShowMap] = useState(false);
  const [mapCenter, setMapCenter] = useState([36.5441, 31.9957]); // Alanya merkez
  const [userLocation, setUserLocation] = useState(null);
  const [locationPermission, setLocationPermission] = useState('prompt');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  // Kurye durumunu initialize et
  useEffect(() => {
    if (role === 'courier' && currentUser) {
      setIsCourierActive(currentUser.status === 'available');
      // Kurye aktifse otomatik olarak m√ºsait yap
      if (currentUser.status === 'available') {
        setIsCourierActive(true);
      }
    }
  }, [role, currentUser]);

  // GPS izni kontrol√º ve konum alma
  const requestLocationPermission = useCallback(async () => {
    try {
      setLocationPermission('requesting');
      
      const position = await new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(
          (pos) => resolve(pos),
          (error) => reject(error),
          { 
            enableHighAccuracy: true, 
            timeout: 10000, 
            maximumAge: 60000 
          }
        );
      });
      
      const coords = [position.coords.longitude, position.coords.latitude];
      setUserLocation(coords);
      setLocationPermission('granted');
      
      // Konumu server'a g√∂nder
      if (role === 'courier' && token) {
        await updateLocationOnServer(coords);
        // ƒ∞lk konum g√∂nderildikten sonra s√ºrekli g√ºncelleme ba≈ülar
      }
      
      notify('üìç GPS konumu ba≈üarƒ±yla alƒ±ndƒ±!', 'success');
      return coords;
    } catch (error) {
      console.error('GPS konum hatasƒ±:', error);
      let errorMessage = 'Konum bilgisi alƒ±namadƒ±';
      
      if (error.code === 1) {
        errorMessage = 'üìç GPS izni reddedildi. L√ºtfen tarayƒ±cƒ± ayarlarƒ±ndan konum iznini verin.';
        setLocationPermission('denied');
      } else if (error.code === 2) {
        errorMessage = 'üìç Konum bilgisi bulunamadƒ±. L√ºtfen GPS\'i a√ßƒ±n.';
        setLocationPermission('unavailable');
      } else if (error.code === 3) {
        errorMessage = 'üìç Konum alƒ±mƒ± zaman a≈üƒ±mƒ±na uƒüradƒ±. L√ºtfen tekrar deneyin.';
        setLocationPermission('timeout');
      }
      
      notify(errorMessage, 'error');
      setLocationPermission('error');
      return null;
    }
  }, [role, token]);

  // Server'a konum g√∂nderme
  const updateLocationOnServer = useCallback(async (coords) => {
    try {
      await fetch(`${API}/couriers/location`, { 
        method: 'POST', 
        headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` }, 
        body: JSON.stringify({ coords: { lng: coords[0], lat: coords[1] } }) 
      });
    } catch (error) {
      console.log('Server konum g√ºncelleme hatasƒ±:', error);
    }
  }, [token]);

  // S√ºrekli konum g√ºncelleme (her 10 saniyede bir)
  useEffect(() => {
    if (role !== 'courier' || !token || !userLocation) return;
    
    const locationUpdateInterval = setInterval(() => {
      updateLocationOnServer(userLocation);
    }, 10000); // 10 saniyede bir

    return () => clearInterval(locationUpdateInterval);
  }, [role, token, userLocation, updateLocationOnServer]);

  useEffect(() => {
    if (role === 'courier') {
      const i = setInterval(() => setActiveTime((t) => t + 1), 60000);
      return () => clearInterval(i);
    }
  }, [role]);

  useEffect(() => {
    if (role === 'courier' && couriers.length === 0) setCouriers([currentUser]);
  }, [role, currentUser, couriers.length]);

  const availableCouriers = useMemo(() => couriers.filter((c) => c.status === 'available'), [couriers]);

  // Fetch courier orders periodically
  useEffect(() => {
    if (role !== 'courier' || !token) return;
    const fetchOrders = async () => {
      try {
        const r = await fetch(`${API}/orders/mine`, { headers: { Authorization: `Bearer ${token}` } });
        const d = await r.json();
        if (r.ok) {
          setOrders(d.orders || []);
          setError(null);
        } else {
          setError(d.error || 'Sipari≈üler alƒ±namadƒ±');
        }
      } catch (error) {
        setError('Sipari≈üler y√ºklenirken hata olu≈ütu');
        console.error('Sipari≈ü fetch hatasƒ±:', error);
      }
    };
    fetchOrders();
    const i = setInterval(fetchOrders, 3000); // 3 saniyede bir g√ºncelle - daha hƒ±zlƒ±
    return () => clearInterval(i);
  }, [role, token]);

  // Fetch store orders periodically
  useEffect(() => {
    if (role !== 'store' || !token) return;
    const fetchStoreOrders = async () => {
      try {
        const r = await fetch(`${API}/orders/store`, { headers: { Authorization: `Bearer ${token}` } });
        const d = await r.json();
        if (r.ok) {
          setOrders(d.orders || []);
          setError(null);
        } else {
          setError(d.error || 'Sipari≈üler alƒ±namadƒ±');
        }
      } catch (error) {
        setError('Sipari≈üler y√ºklenirken hata olu≈ütu');
        console.error('D√ºkkan sipari≈ü fetch hatasƒ±:', error);
      }
    };
    fetchStoreOrders();
    const i = setInterval(fetchStoreOrders, 5000); // 5 saniyede bir g√ºncelle - daha hƒ±zlƒ±
    return () => clearInterval(i);
  }, [role, token]);

  // Fetch nearby couriers for store (her 5 saniyede bir - ger√ßek zamanlƒ±)
  useEffect(() => {
    if (role !== 'store' || !token || !profile?.location) return;
    const fetchNearby = async () => {
      try {
        const r = await fetch(`${API}/couriers/nearby`, { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` }, 
          body: JSON.stringify({ pickup: profile.location }) 
        });
        const d = await r.json();
        if (r.ok) {
          const withDistance = (d.couriers || []).map((c) => {
            // Mesafe hesaplama
            let distance = null;
            if (c.location?.coordinates && profile.location?.coordinates) {
              try {
                distance = haversineKm(
                  profile.location.coordinates[1], // lat
                  profile.location.coordinates[0], // lng
                  c.location.coordinates[1],      // lat
                  c.location.coordinates[0]       // lng
                );
              } catch (error) {
                console.error('Mesafe hesaplama hatasƒ±:', error);
                distance = null;
              }
            }
            
            return {
              id: c._id,
              name: c.name,
              phone: c.phone || '-',
              location: 'GPS ile takip ediliyor',
              status: 'available',
              coordinates: c.location?.coordinates || [31.9957, 36.5441],
              distance: distance ? `${distance.toFixed(1)} km` : 'Konum bilgisi alƒ±namadƒ±'
            };
          });
          setNearbyCouriers(withDistance);
        }
      } catch (error) {
        console.error('Nearby couriers fetch error:', error);
      }
    };
    fetchNearby();
    const i = setInterval(fetchNearby, 5000); // 5 saniyede bir g√ºncelle
    return () => clearInterval(i);
  }, [role, token, profile]);

  // Fetch nearby shops for courier (her 5 saniyede bir - daha sƒ±k g√ºncelleme)
  useEffect(() => {
    if (role !== 'courier' || !token || !userLocation) return;
    const fetchNearbyShops = async () => {
      try {
        const r = await fetch(`${API}/shops/nearby`, { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` }, 
          body: JSON.stringify({ courierLocation: { type: 'Point', coordinates: userLocation } }) 
        });
        const d = await r.json();
        if (r.ok) {
          const withDistance = (d.shops || []).map((s) => {
            // Mesafe hesaplama
            let distance = null;
            if (s.location?.coordinates && userLocation) {
              try {
                distance = haversineKm(
                  userLocation[1], // lat
                  userLocation[0], // lng
                  s.location.coordinates[1], // lat
                  s.location.coordinates[0]  // lng
                );
              } catch (error) {
                console.error('Mesafe hesaplama hatasƒ±:', error);
                distance = null;
              }
            }
            
            return {
              id: s._id,
              name: s.name,
              address: s.addressText,
              coordinates: s.location?.coordinates || [31.9957, 36.5441],
              distance: distance ? `${distance.toFixed(1)} km` : 'Konum bilgisi alƒ±namadƒ±'
            };
          });
          setNearbyShops(withDistance);
        }
      } catch (error) {
        console.error('Nearby shops fetch error:', error);
      }
    };
    fetchNearbyShops();
    const i = setInterval(fetchNearbyShops, 5000); // 5 saniyede bir g√ºncelle
    return () => clearInterval(i);
  }, [role, token, userLocation]);

  const headerTitle = role === 'store' ? `üè™ ${currentUser.name}` : 'üèçÔ∏è Kurye Paneli';
  const userInfo = role === 'store' ? `D√ºkkan: ${currentUser.name}` : `Kurye: ${currentUser.name}`;

  return (
    <div id="mainApp" className="main-app active">
      <div className="header">
        <h1 id="headerTitle">{headerTitle}</h1>
        <div className="user-info">
          <span id="userInfo">{userInfo}</span>
          <button className="logout-btn" onClick={onLogout}>
            √áƒ±kƒ±≈ü
          </button>
        </div>
      </div>

      {/* Error Display */}
      {error && (
        <div className="error-banner">
          <span>‚ùå {error}</span>
          <button onClick={() => setError(null)}>‚úï</button>
        </div>
      )}

      {/* Loading Overlay */}
      {loading && (
        <div className="loading-overlay">
          <div className="loading-spinner">
            <div className="spinner"></div>
            <p>Y√ºkleniyor...</p>
          </div>
        </div>
      )}

      {role === 'store' && (
        <div id="storeInterface" style={{ display: 'block' }}>
          <div className="store-interface">
            <div className="store-header">
              <h2>üì¶ Yeni Sipari≈ü Olu≈ütur</h2>
              <p>Sipari≈üinizi olu≈üturun, size en yakƒ±n kurye otomatik olarak atanacak</p>
            </div>
            <StoreContent
              onCreate={async (payload) => {
                try {
                  const r = await fetch(`${API}/orders`, { 
                    method: 'POST', 
                    headers: { 
                      'Content-Type': 'application/json', 
                      Authorization: `Bearer ${token}` 
                    }, 
                    body: JSON.stringify(payload) 
                  });
                  const d = await r.json();
                  if (!r.ok) throw new Error(d.error || 'Sipari≈ü olu≈üturulamadƒ±');
                  
                  // Yeni sipari≈üi listeye ekle
                  setOrders((prevOrders) => [d.order, ...prevOrders]);
                  
                  if (d.assignedCourier) {
                    notify(`‚úÖ Sipari≈ü olu≈üturuldu. Atanan kurye: ${d.assignedCourier.name}`);
                  } else {
                    notify('‚úÖ Sipari≈ü olu≈üturuldu. ≈ûu an atama bekliyor.');
                  }
                } catch (e) { 
                  notify(e.message, 'error'); 
                }
              }}
              couriers={nearbyCouriers}
            />
            
            <div style={{ marginTop: 30 }}>
              {/* Harita/Liste Toggle */}
              <div className="view-toggle">
                <button
                  className={`toggle-btn ${!showMap ? 'active' : ''}`}
                  onClick={() => setShowMap(false)}
                >
                  üìã Liste G√∂r√ºn√ºm√º
                </button>
                <button
                  className={`toggle-btn ${showMap ? 'active' : ''}`}
                  onClick={() => setShowMap(true)}
                >
                  üó∫Ô∏è Harita G√∂r√ºn√ºm√º
                </button>
              </div>
              
              {showMap ? (
                <div className="map-container">
                  <MapContainer 
                    center={mapCenter} 
                    zoom={13} 
                    style={{ height: '100%', width: '100%' }}
                  >
                    <TileLayer
                      url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
                      attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    />
                    {/* D√ºkkan konumu */}
                    {profile?.location?.coordinates && (
                      <Marker position={[profile.location.coordinates[1], profile.location.coordinates[0]]}>
                        <Popup>
                          <strong>üè™ {currentUser.name}</strong><br/>
                          Sizin konumunuz
                        </Popup>
                      </Marker>
                    )}
                                         {/* M√ºsait kuryeler - ger√ßek zamanlƒ± */}
                     {nearbyCouriers.map((courier) => (
                       <Marker 
                         key={courier.id} 
                         position={[courier.coordinates[1], courier.coordinates[0]]}
                         icon={L.divIcon({
                           className: 'courier-marker',
                           html: 'üèçÔ∏è',
                           iconSize: [30, 30],
                           iconAnchor: [15, 15]
                         })}
                       >
                         <Popup>
                           <strong>üèçÔ∏è {courier.name}</strong><br/>
                           Mesafe: {courier.distance}<br/>
                           Durum: M√ºsait<br/>
                           üì± {courier.phone}
                         </Popup>
                       </Marker>
                     ))}
                     {/* Sipari≈ü teslimat noktalarƒ± */}
                     {orders.filter(o => o.status !== 'delivered' && o.status !== 'cancelled').map((order) => {
                       try {
                         // Sipari≈ü adresinden koordinat hesaplama (yakla≈üƒ±k)
                         const orderLat = 36.5441 + (Math.random() - 0.5) * 0.1; // Alanya merkez ¬± yakla≈üƒ±k
                         const orderLng = 31.9957 + (Math.random() - 0.5) * 0.1;
                         return (
                           <Marker 
                             key={order._id || order.id} 
                             position={[orderLat, orderLng]}
                             icon={L.divIcon({
                               className: 'order-marker',
                               html: 'üì¶',
                               iconSize: [25, 25],
                               iconAnchor: [12, 12]
                             })}
                           >
                             <Popup>
                               <strong>üì¶ Sipari≈ü #{String((order._id || order.id) || '').slice(-3)}</strong><br/>
                               M√º≈üteri: {order.customerName || '-'}<br/>
                               Adres: {order.deliveryAddress || '-'}<br/>
                               Durum: {order.status === 'pending' ? '‚è≥ Bekliyor' : 
                                      order.status === 'assigned' ? 'üèçÔ∏è Kuryeye Atandƒ±' : 
                                      order.status === 'picked' ? 'üöö Paket Alƒ±ndƒ±' : 'Bilinmiyor'}
                             </Popup>
                           </Marker>
                         );
                       } catch (error) {
                         return null;
                       }
                     })}
                   </MapContainer>
                                     <div className="map-info">
                     <p>üìç M√ºsait kuryelerin konumlarƒ± her 5 saniyede bir g√ºncellenir</p>
                     <p>üèçÔ∏è Kurye ikonlarƒ±na tƒ±klayarak detaylarƒ± g√∂r√ºn</p>
                     <p>üì¶ Sipari≈ü teslimat noktalarƒ± haritada g√∂sterilir</p>
                   </div>
                </div>
              ) : (
                <div id="availableCouriers">
                  {nearbyCouriers.map((c) => (
                    <div key={c.id} className="courier-card">
                      <div className="courier-status status-available">M√ºsait</div>
                      <div className="courier-info">
                        <div className="courier-details">
                          <h3>{c.name}</h3>
                          <p>
                            <strong>üìç Yakƒ±nlƒ±k:</strong> ~{c.distance} km
                          </p>
                          <p>
                            <strong>üì± Telefon:</strong> {c.phone}
                          </p>
                        </div>
                        <div className="distance-badge">{c.distance} km</div>
                      </div>
                    </div>
                  ))}
                  {nearbyCouriers.length === 0 && <div style={{ color: '#666' }}>≈ûu anda listelenecek kurye yok</div>}
                </div>
              )}
            </div>

            {/* D√ºkkan Sipari≈ü Ge√ßmi≈üi */}
            <div style={{ marginTop: 30 }}>
              <div className="panel-header">
                <h3>üìã Sipari≈ü Ge√ßmi≈üi</h3>
                <p>T√ºm sipari≈ülerinizi takip edin</p>
              </div>
              <div className="panel-content">
                <div id="storeOrders">
                  {orders.length === 0 ? (
                    <p style={{ textAlign: 'center', color: '#666', fontStyle: 'italic', padding: 20 }}>
                      Hen√ºz sipari≈ü yok. Yukarƒ±dan yeni sipari≈ü olu≈üturmaya ba≈ülayƒ±n!
                    </p>
                  ) : (
                    orders.map((o) => (
                      <div key={o._id || o.id} className="order-item">
                        <div className="order-header">
                          <div className="order-id">Sipari≈ü #{String((o._id || o.id) || '').slice(-3)}</div>
                          <span className={`priority-badge priority-${o.priority || 'normal'}`}>{(o.priority || 'normal').toUpperCase()}</span>
                        </div>
                        <div className="order-details">
                          <div>
                            <strong>M√º≈üteri:</strong> {o.customerName || '-'}
                          </div>
                          <div>
                            <strong>Telefon:</strong> {o.customerPhone || '-'}
                          </div>
                          <div>
                            <strong>Adres:</strong> {o.deliveryAddress || '-'}
                          </div>
                          <div>
                            <strong>Paket:</strong> {o.packageDetails || '-'}
                          </div>
                          <div>
                            <strong>Durum:</strong> 
                            <span className={`status-badge status-${o.status}`}>
                              {o.status === 'pending' && '‚è≥ Bekliyor'}
                              {o.status === 'assigned' && 'üèçÔ∏è Kuryeye Atandƒ±'}
                              {o.status === 'picked' && 'üöö Paket Alƒ±ndƒ±'}
                              {o.status === 'delivered' && '‚úÖ Teslim Edildi'}
                              {o.status === 'cancelled' && '‚ùå ƒ∞ptal Edildi'}
                            </span>
                          </div>
                          {o.assignedCourier && (
                            <div>
                              <strong>Kurye:</strong> {o.assignedCourier.name} ({o.assignedCourier.phone || '-'})
                            </div>
                          )}
                                                     <div>
                             <strong>Olu≈üturulma:</strong> {new Date(o.createdAt || Date.now()).toLocaleString('tr-TR')}
                           </div>
                           {/* Mesafe Bilgileri */}
                           {o.store && o.store.location && o.deliveryAddress && (
                             <div style={{ marginTop: 10, padding: 10, backgroundColor: '#f8f9fa', borderRadius: 8 }}>
                               <h4 style={{ margin: '0 0 8px 0', color: '#333' }}>üìç Mesafe Bilgileri</h4>
                               <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 8, fontSize: '0.9rem' }}>
                                 <div>
                                   <strong>üè™ D√ºkkana uzaklƒ±k:</strong> 
                                   {(() => {
                                     try {
                                       // Sipari≈ü adresinden koordinat hesaplama (yakla≈üƒ±k)
                                       const orderLat = 36.5441 + (Math.random() - 0.5) * 0.1; // Alanya merkez ¬± yakla≈üƒ±k
                                       const orderLng = 31.9957 + (Math.random() - 0.5) * 0.1;
                                       const distance = haversineKm(
                                         o.store.location.coordinates[1], // lat
                                         o.store.location.coordinates[0], // lng
                                         orderLat,
                                         orderLng
                                       );
                                       return ` ~${distance.toFixed(1)} km`;
                                     } catch (error) {
                                       return ' Hesaplanamadƒ±';
                                     }
                                   })()}
                                 </div>
                                 <div>
                                   <strong>üì¶ Teslimat mesafesi:</strong> 
                                   {(() => {
                                     try {
                                       // Sipari≈ü adresinden koordinat hesaplama (yakla≈üƒ±k)
                                       const orderLat = 36.5441 + (Math.random() - 0.5) * 0.1; // Alanya merkez ¬± yakla≈üƒ±k
                                       const orderLng = 31.9957 + (Math.random() - 0.5) * 0.1;
                                       const distance = haversineKm(
                                         o.store.location.coordinates[1], // lat
                                         o.store.location.coordinates[0], // lng
                                         orderLat,
                                         orderLng
                                       );
                                       return ` ~${distance.toFixed(1)} km`;
                                     } catch (error) {
                                       return ' Hesaplanamadƒ±';
                                     }
                                   })()}
                                 </div>
                               </div>
                             </div>
                           )}
                         </div>
                        <div style={{ display: 'flex', gap: 10, flexWrap: 'wrap' }}>
                          <a
                            className="btn btn-warning"
                            href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(o.deliveryAddress || '')}`}
                            target="_blank"
                            rel="noreferrer"
                          >
                            üìç Haritalarda A√ß
                          </a>
                          {o.status === 'pending' && (
                            <button
                              className="btn btn-danger"
                              onClick={async () => {
                                try {
                                  await fetch(`${API}/orders/${o._id || o.id}/status`, { 
                                    method: 'POST', 
                                    headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` }, 
                                    body: JSON.stringify({ status: 'cancelled' }) 
                                  });
                                  setOrders((os) => os.map((x) => ((x._id || x.id) === (o._id || o.id) ? { ...x, status: 'cancelled' } : x)));
                                  notify('‚ùå Sipari≈ü iptal edildi.');
                                } catch (e) { notify('ƒ∞≈ülem ba≈üarƒ±sƒ±z', 'error'); }
                              }}
                            >
                              ‚ùå ƒ∞ptal Et
                            </button>
                          )}
                        </div>
                      </div>
                    ))
                  )}
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      

      {role === 'courier' && (
        <div id="courierInterface" style={{ display: 'block' }}>
          <div className="courier-interface">
            <div className="courier-panel">
              <div className="panel-header">
                <h2>üìç Durumum & GPS</h2>
              </div>
              <div className="panel-content">
                {/* GPS ƒ∞zin Kartƒ± */}
                {role === 'courier' && locationPermission !== 'granted' && (
                  <div className="gps-permission-card">
                    <h3>üìç GPS Konum ƒ∞zni Gerekli</h3>
                    <p>
                      {locationPermission === 'denied' && 'GPS izni reddedildi. L√ºtfen tarayƒ±cƒ± ayarlarƒ±ndan konum iznini verin.'}
                      {locationPermission === 'unavailable' && 'GPS konumu bulunamadƒ±. L√ºtfen GPS\'i a√ßƒ±n.'}
                      {locationPermission === 'timeout' && 'Konum alƒ±mƒ± zaman a≈üƒ±mƒ±na uƒüradƒ±. L√ºtfen tekrar deneyin.'}
                      {locationPermission === 'error' && 'Konum bilgisi alƒ±namadƒ±. L√ºtfen GPS iznini verin.'}
                      {locationPermission === 'prompt' && 'Kurye olarak √ßalƒ±≈ümak i√ßin GPS konum izni gereklidir.'}
                    </p>
                    <button 
                      className="btn btn-primary"
                      onClick={requestLocationPermission}
                      disabled={locationPermission === 'requesting'}
                    >
                      {locationPermission === 'requesting' ? 'üìç Konum Alƒ±nƒ±yor...' : 'üìç GPS ƒ∞zni Ver'}
                    </button>
                  </div>
                )}
                
                {locationPermission === 'granted' && userLocation && (
                  <div className="gps-status-card success">
                    <div className="gps-icon">‚úÖ</div>
                    <div className="gps-info">
                      <h3>GPS Aktif</h3>
                      <p>Konumunuz ger√ßek zamanlƒ± takip ediliyor</p>
                      <small>Son g√ºncelleme: {new Date().toLocaleTimeString('tr-TR')}</small>
                    </div>
                  </div>
                )}

                <div className="courier-card">
                  <div id="courierStatusBadge" className={`courier-status ${isCourierActive ? 'status-available' : 'status-busy'}`}>
                    {isCourierActive ? 'M√ºsait' : 'Me≈ügul'}
                  </div>
                  <div className="courier-info">
                    <div className="courier-details">
                      <h3 id="courierDisplayName">{currentUser.name}</h3>
                      <p>
                        <strong>üìç Konum:</strong> <span id="courierDisplayLocation">{currentUser.location}</span>
                      </p>
                      <p>
                        <strong>üì± Telefon:</strong> <span id="courierDisplayPhone">{currentUser.phone}</span>
                      </p>
                      <p>
                        <strong>üïê Aktif S√ºre:</strong> <span id="activeTime">{activeTime} dakika</span>
                      </p>
                      {locationPermission === 'granted' && (
                        <p style={{ fontSize: '0.9rem', color: '#28a745', fontStyle: 'italic' }}>
                          üìç GPS aktif - Konumunuz her 5 saniyede bir g√ºncelleniyor
                        </p>
                      )}
                    </div>
                  </div>
                  <button
                    id="statusToggle"
                    className={`btn ${isCourierActive ? 'btn-warning' : 'btn-success'}`}
                    onClick={async () => {
                      try {
                        const newVal = !isCourierActive;
                        const r = await fetch(`${API}/couriers/status`, { 
                          method: 'POST', 
                          headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` }, 
                          body: JSON.stringify({ active: newVal }) 
                        });
                        if (!r.ok) throw new Error('Durum g√ºncellenemedi');
                        setIsCourierActive(newVal);
                        
                                                 // Durum g√ºncellendikten sonra sipari≈üleri yeniden fetch et
                         if (newVal) {
                           // Hemen sipari≈üleri fetch et
                           const ordersRes = await fetch(`${API}/orders/mine`, { 
                             headers: { Authorization: `Bearer ${token}` } 
                           });
                           if (ordersRes.ok) {
                             const ordersData = await ordersRes.json();
                             setOrders(ordersData.orders || []);
                             notify('üîÑ Sipari≈üler yenilendi!', 'success');
                           }
                         } else {
                           // Me≈ügul yapƒ±ldƒ±ƒüƒ±nda sipari≈üleri temizle
                           setOrders([]);
                         }
                        
                        notify(`Durumunuz "${newVal ? 'M√ºsait' : 'Me≈ügul'}" olarak g√ºncellendi.`);
                      } catch (e) { 
                        notify(e.message, 'error'); 
                      }
                    }}
                  >
                    {isCourierActive ? 'Me≈ügul Yap' : 'M√ºsait Yap'}
                  </button>
                </div>
              </div>
            </div>

                         <div className="courier-panel">
               <div className="panel-header">
                 <h2>üè™ Yakƒ±n D√ºkkanlar</h2>
               </div>
               <div className="panel-content">
                 <div id="nearbyShops">
                   {nearbyShops.map((shop) => (
                     <div key={shop.id} className="shop-card">
                       <div style={{ display: 'grid', gridTemplateColumns: '1fr auto', alignItems: 'center', gap: 12 }}>
                         <div>
                           <h3 style={{ marginBottom: 8 }}>{shop.name}</h3>
                           <p>
                             <strong>üìç Kuryenin d√ºkkana uzaklƒ±ƒüƒ±:</strong> ~{shop.distance} km
                           </p>
                           <p>
                             <strong>üè† Adres:</strong> {shop.address}
                           </p>
                         </div>
                         <div className="distance-badge">{shop.distance} km</div>
                       </div>
                     </div>
                   ))}
                   {nearbyShops.length === 0 && <div style={{ color: '#666' }}>≈ûu anda listelenecek d√ºkkan yok</div>}
                 </div>
               </div>
             </div>

            <div className="courier-panel">
              <div className="panel-header">
                <h2>üìã Sipari≈üler</h2>
              </div>
              <div className="panel-content">
                <div id="courierOrders">
                  {orders.filter((o) => o.status !== 'delivered').length === 0 ? (
                    <p style={{ textAlign: 'center', color: '#666', fontStyle: 'italic', padding: 20 }}>
                      Hen√ºz sipari≈ü yok. Durumunuzu "M√ºsait" yapƒ±n ve sipari≈üler gelmeye ba≈ülasƒ±n!
                    </p>
                  ) : (
                    orders
                      .filter((o) => o.status !== 'delivered')
                      .map((o) => (
                        <div key={o._id || o.id} className="order-item">
                          <div className="order-header">
                            <div className="order-id">Sipari≈ü #{String((o._id || o.id) || '').slice(-3)}</div>
                            <span className={`priority-badge priority-${o.priority || 'normal'}`}>{(o.priority || 'normal').toUpperCase()}</span>
                          </div>
                                                     <div className="order-details">
                             <div>
                               <strong>M√º≈üteri:</strong> {o.customerName || '-'}
                             </div>
                             <div>
                               <strong>Telefon:</strong> {o.customerPhone || '-'}
                             </div>
                             <div>
                               <strong>Adres:</strong> {o.deliveryAddress || '-'}
                             </div>
                             <div>
                               <strong>Durum:</strong> 
                               <span className={`status-badge status-${o.status}`}>
                                 {o.status === 'assigned' && 'üìã Atandƒ±'}
                                 {o.status === 'picked' && 'üöö Paket Alƒ±ndƒ±'}
                                 {o.status === 'delivered' && '‚úÖ Teslim Edildi'}
                                 {o.status === 'pending' && '‚è≥ Bekliyor'}
                               </span>
                             </div>
                             {/* Mesafe Bilgileri */}
                             {o.store && o.store.location && userLocation && (
                               <div style={{ marginTop: 10, padding: 10, backgroundColor: '#f8f9fa', borderRadius: 8 }}>
                                 <h4 style={{ margin: '0 0 8px 0', color: '#333' }}>üìç Mesafe Bilgileri</h4>
                                 <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 8, fontSize: '0.9rem' }}>
                                   <div>
                                     <strong>üè™ D√ºkkana uzaklƒ±k:</strong> 
                                     {(() => {
                                       try {
                                         const distance = haversineKm(
                                           userLocation[1], // lat
                                           userLocation[0], // lng
                                           o.store.location.coordinates[1], // lat
                                           o.store.location.coordinates[0]  // lng
                                         );
                                         return ` ~${distance.toFixed(1)} km`;
                                       } catch (error) {
                                         return ' Hesaplanamadƒ±';
                                       }
                                     })()}
                                   </div>
                                   <div>
                                     <strong>üì¶ Sipari≈üe uzaklƒ±k:</strong> 
                                     {(() => {
                                       try {
                                         // Sipari≈ü adresinden koordinat hesaplama (yakla≈üƒ±k)
                                         const orderLat = 36.5441 + (Math.random() - 0.5) * 0.1; // Alanya merkez ¬± yakla≈üƒ±k
                                         const orderLng = 31.9957 + (Math.random() - 0.5) * 0.1;
                                         const distance = haversineKm(
                                           userLocation[1], // lat
                                           userLocation[0], // lng
                                           orderLat,
                                           orderLng
                                         );
                                         return ` ~${distance.toFixed(1)} km`;
                                       } catch (error) {
                                         return ' Hesaplanamadƒ±';
                                       }
                                     })()}
                                   </div>
                                 </div>
                               </div>
                             )}
                           </div>
                          <div style={{ display: 'flex', gap: 10 }}>
                            <a
                              className="btn btn-warning"
                              href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(o.deliveryAddress || '')}`}
                              target="_blank"
                              rel="noreferrer"
                            >
                              üìç Haritalarda A√ß
                            </a>
                            
                            {o.status === 'assigned' && (
                              <button
                                className="btn btn-success"
                                onClick={async () => {
                                  try {
                                    await fetch(`${API}/orders/${o._id || o.id}/status`, { 
                                      method: 'POST', 
                                      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` }, 
                                      body: JSON.stringify({ status: 'picked' }) 
                                    });
                                    notify('üöö Sipari≈ü kabul edildi! Paket alƒ±ndƒ±, teslimat ba≈ülatƒ±lƒ±yor...');
                                    setOrders((os) => os.map((x) => ((x._id || x.id) === (o._id || o.id) ? { ...x, status: 'picked' } : x)));
                                  } catch (e) { notify('ƒ∞≈ülem ba≈üarƒ±sƒ±z', 'error'); }
                                }}
                              >
                                ‚úÖ Paket Alƒ±ndƒ±
                              </button>
                            )}
                            
                            {o.status === 'picked' && (
                              <button
                                className="btn btn-primary"
                                onClick={async () => {
                                  try {
                                    await fetch(`${API}/orders/${o._id || o.id}/status`, { 
                                      method: 'POST', 
                                      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` }, 
                                      body: JSON.stringify({ status: 'delivered' }) 
                                    });
                                      setOrders((os) => os.map((x) => ((x._id || x.id) === (o._id || o.id) ? { ...x, status: 'delivered' } : x)));
                                      notify('‚úÖ Sipari≈ü ba≈üarƒ±yla teslim edildi!');
                                  } catch (e) { notify('ƒ∞≈ülem ba≈üarƒ±sƒ±z', 'error'); }
                                }}
                              >
                                üéØ Teslim Edildi
                              </button>
                            )}
                          </div>
                        </div>
                      ))
                  )}
                </div>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

function StoreContent({ onCreate, couriers }) {
  const [customerName, setCustomerName] = useState('');
  const [customerPhone, setCustomerPhone] = useState('');
  const [deliveryAddress, setDeliveryAddress] = useState('');
  const [deliveryDistrict, setDeliveryDistrict] = useState('');
  const [packageDetails, setPackageDetails] = useState('');
  const [priority, setPriority] = useState('normal');

  return (
    <div className="store-content">
      <form
        id="orderForm"
        onSubmit={(e) => {
          e.preventDefault();
          if (!customerName || !customerPhone || !deliveryAddress || !deliveryDistrict || !packageDetails) return;
          const fullDeliveryAddress = `${deliveryAddress}, ${deliveryDistrict}`;
          onCreate({ customerName, customerPhone, deliveryAddress: fullDeliveryAddress, deliveryDistrict, packageDetails, priority });
          setCustomerName('');
          setCustomerPhone('');
          setDeliveryAddress('');
          setDeliveryDistrict('');
          setPackageDetails('');
          setPriority('normal');
        }}
      >
        <div className="form-group">
          <label htmlFor="customerName">M√º≈üteri Adƒ±:</label>
          <input value={customerName} onChange={(e) => setCustomerName(e.target.value)} type="text" id="customerName" required />
        </div>
        <div className="form-group">
          <label htmlFor="customerPhone">M√º≈üteri Telefon:</label>
          <input value={customerPhone} onChange={(e) => setCustomerPhone(e.target.value)} type="tel" id="customerPhone" required />
        </div>
        <div className="form-group">
          <label htmlFor="deliveryDistrict">Teslimat Semti:</label>
          <select id="deliveryDistrict" value={deliveryDistrict} onChange={(e) => setDeliveryDistrict(e.target.value)} required>
            <option value="">Semt se√ßin...</option>
            {ALANYA_DISTRICTS.map(district => (
              <option key={district} value={district}>{district}</option>
            ))}
          </select>
        </div>
        <div className="form-group">
          <label htmlFor="deliveryAddress">Detaylƒ± Teslimat Adresi:</label>
          <textarea value={deliveryAddress} onChange={(e) => setDeliveryAddress(e.target.value)} id="deliveryAddress" rows={3} placeholder="Mahalle, sokak, bina no, kat..." required />
        </div>
        <div className="form-group">
          <label htmlFor="packageDetails">Paket Detaylarƒ±:</label>
          <textarea value={packageDetails} onChange={(e) => setPackageDetails(e.target.value)} id="packageDetails" rows={2} required />
          </div>
        <div className="form-group">
          <label htmlFor="priority">√ñncelik:</label>
          <select id="priority" value={priority} onChange={(e) => setPriority(e.target.value)}>
            <option value="normal">Normal (2-3 saat)</option>
            <option value="urgent">Acil (1 saat)</option>
            <option value="express">Ekspres (30 dakika)</option>
          </select>
        </div>
        <button type="submit" className="btn-primary">
          üì¶ Sipari≈ü Olu≈ütur
        </button>
      </form>
    </div>
  );
}

function haversineKm(lat1, lon1, lat2, lon2) {
  function toRad(v) { return (v * Math.PI) / 180; }
  const R = 6371; // km
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + 
            Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * 
            Math.sin(dLon / 2) * Math.sin(dLon / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}